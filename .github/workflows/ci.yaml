name: CI

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest requests

      - name: Start Flask server (background)
        run: |
          nohup python app.py > server.log 2>&1 &
          sleep 3

      - name: Run tests
        run: |
          pytest --junitxml=report.xml

      - name: Upload JUnit report
        uses: actions/upload-artifact@v4
        with:
          name: junit-report
          path: report.xml

      - name: Send Slack Notification
        if: always()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          python -c "
import os
import xml.etree.ElementTree as ET
import requests

try:
    tree = ET.parse('report.xml')
    root = tree.getroot()

    tests = int(root.attrib.get('tests', 0))
    failures = int(root.attrib.get('failures', 0))
    errors = int(root.attrib.get('errors', 0))
    skipped = int(root.attrib.get('skipped', 0)) if 'skipped' in root.attrib else 0
    passed = tests - failures - errors - skipped

    state = 'SUCCESS' if failures == 0 and errors == 0 else 'FAILURE'
    summary = f'Tests: {tests}, Passed: {passed}, Failures: {failures}, Errors: {errors}, Skipped: {skipped}'

    payload = {'text': f':robot_face: *CI Test Report - {state}*\n{summary}'}

    webhook = os.getenv('SLACK_WEBHOOK')
    if webhook:
        requests.post(webhook, json=payload, timeout=10)
    else:
        print('SLACK_WEBHOOK is not set')

except Exception as e:
    print('Error sending Slack message:', e)
"

